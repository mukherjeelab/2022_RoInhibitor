---
title: "Ro ENCODE RBP Correlation"
output: html_document
author: "Neel Mukherjee"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(clusterProfiler)
library(enrichplot)
library(here)
library(tidyverse)
library(viridis)
library(pheatmap)
library(GeneOverlap)
library(janitor)
library(ggthemes)
library(rstatix)
library(ggpubr)

`%notin%` <- Negate(`%in%`)
```

```{r data, echo=FALSE, message=FALSE, warning=FALSE}

rbp_stat <- read_tsv("data/EncodeCorrelation/encode_k562_stat.tsv.gz")

ro <- read_tsv("data/EncodeCorrelation/H295R_ro_12h_dge.tsv.zip")

pisa <- read_tsv("data/PISA/VolPlot_PerseusExport.txt") %>%
  clean_names() %>%
  filter(significant=="+") %>%
  pull(gene_name)

```

```{r correlation}
colnames(rbp_stat)[1] <- "ID"

cor_data <- inner_join(ro %>% select(ID,stat),rbp_stat) %>%
  as.data.frame() %>% na.omit()

colnames(cor_data) <- gsub(pattern = "_log2FC", replacement = "", x = colnames(cor_data))  

colnames(cor_data) <- gsub(pattern = "_stat", replacement = "", x = colnames(cor_data))  


mydata <- cor_data %>% 
  dplyr::select_if(is.numeric) %>%
  as.matrix()


mydata_pearson <- Hmisc::rcorr(mydata, type = "pearson")

pearCor <- data.frame(rbp=rownames(mydata_pearson$r),
           Pearson=mydata_pearson$r[,1],
           pval=mydata_pearson$P[,1]) %>% 
  filter(rbp!="stat") %>%
  mutate(
      pisa = case_when(
      rbp %in% pisa ~ "interaction",
      rbp %in% ro$symbol ~ "no interaction",
      TRUE ~ "not detected"
      )
    )
  


tmp <- read_tsv("data/PISA/VolPlot_PerseusExport.txt") %>%
  clean_names() %>% 
  select(gene_name,difference)

pearCor <- merge(pearCor, tmp, by.x = "rbp", by.y="gene_name", all.x = T)


pisaANDencode <- pearCor %>% filter(pisa=="interaction" | rbp =="MSI2" ) %>% 
  mutate(
    cat = case_when(
      pval < .05 & Pearson > 0 ~ "similar",
      pval < .05 & Pearson < 0 ~ "opposite",
      rbp=="MSI2" ~ "MSI2",
      TRUE ~ "no relationship"
    ) %>% as.factor()
  )


pisaANDencode$cat <- factor(pisaANDencode$cat, levels = c("similar", "no relationship", "MSI2", "opposite"))

mypal <- c("#CC79A7",
"#000000",
"#F0E442",
"#56B4E9")

barplot <- ggbarplot(pisaANDencode, x = "rbp", y = "Pearson", sort.val = "desc", sort.by.groups = F, fill = "cat",
  label = F, label.pos = "out", palette = mypal) + rotate_x_text(60) + ylim(-.35,.35)


p_pisa_knockdown <- ggdotchart(pisaANDencode, x = "rbp", y = "Pearson", sorting = "descending", add = "segments", color = "cat", palette = mypal, dot.size = 3) +  ylim(-.37,.37) + geom_hline(yintercept = 0, linetype = 2, color = "lightgray") + xlab("") + ylab("Correlation") + theme(legend.position="none")


ggsave("plots/Fig3_pisa_knockdownCorr.pdf", plot = p_pisa_knockdown, width = 4, height = 3)

```


